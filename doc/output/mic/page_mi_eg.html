<HTML>
  <HEAD>
    <meta http-equiv="Content-Type" content="text/html;charset=UTF-8">
    <TITLE>i5/OS Programmer's Toolkit - MI/EMI Programmer's Guide</TITLE>
    <link href="tabs.css" rel="stylesheet" type="text/css">
    <link href="doxygen.css" rel="stylesheet" type="text/css">
    <link href="docs.css" rel="stylesheet" type="text/css">

    <table width="100%" border="0" cellspacing="0" cellpadding="0">
      <tr>
        <td align="left">
          <a href="http://sourceforge.net/donate/index.php?group_id=254578"><img src="http://images.sourceforge.net/images/project-support.jpg" width="88" height="32" border="0" alt="Support This Project" /> </a>
        </td>
        <td align="right">
          <a href="http://sourceforge.net/projects/i5toolkit"><img src="http://sflogo.sourceforge.net/sflogo.php?group_id=254578&amp;type=13" width="120" height="30" alt="Get i5/OS Programmer's Toolkit at SourceForge.net. Fast, secure and Free Open Source software downloads" /></a>
        </td>

      </tr>
    </table>

  </HEAD>
  <body>
<!-- Generated by Doxygen 1.5.9 -->
<div class="navigation" id="top">
  <div class="tabs">
    <ul>
      <li><a href="index.html"><span>Main&nbsp;Page</span></a></li>
      <li class="current"><a href="pages.html"><span>Related&nbsp;Pages</span></a></li>
    </ul>
  </div>
</div>
<div class="contents">
<h1><a class="anchor" name="page_mi_eg">Example Programs for MI/EMI Novice </a></h1>Go back to <a href="../index.html">main page</a> of i5/OS Programmer's Toolkit.<p>
<b>Date Last Modified:</b> Mon Sep 7 15:44:39 CST 2009 <dl class="attention" compact><dt><b>Attention:</b></dt><dd>This page is to be enriched from time to time. Please take note of the project's summary page <a href="https://sourceforge.net/projects/i5toolkit/">https://sourceforge.net/projects/i5toolkit/</a> for update notification.</dd></dl>
Here're some example MI (Machine Interface Instructions) programs for MI novice. All programs provided here confirm to <a class="el" href="index.html#sect_mic_syntax_spec">EMI Syntax Specification</a>. For usage information of a specific MI instruction, please refer to IBM's documentation on Machine Interface Instructions, <a href="http://publib.boulder.ibm.com/infocenter/iseries/v5r4/index.jsp?topic=/rzatk/mitoc.htm">i5/OS Machine Interface </a> For document of MIC builtins, please refer to <a class="el" href="page_mic_builtin.html">Specifications of EMI Builtins</a>.<p>
<b>Contents</b><ul>
<li><a class="el" href="page_emi_directives.html#ss_emi_directives_cond_eg">Example of Using EMI Conditional Compilation Directives</a></li><li><a class="el" href="page_mi_eg_uim.html">Interact with Users Using EMI's UIM Builtins</a></li><li><a class="el" href="page_mi_eg.html#sect_mi_eg_01">Print OS Version Information</a></li><li><a class="el" href="page_mi_eg.html#sect_mi_eg_02">List Activation Groups of One's Current Job</a></li><li><a class="el" href="page_mi_eg.html#sect_mi_eg_03">List Activation Entries in a Specific Activation Group</a></li><li><a class="el" href="page_mi_eg.html#sect_mi_eg_04">Use EMI Includes</a></li><li><a class="el" href="page_mi_eg.html#sect_mi_eg_05">Operate Stream Files using EMI Stream File Bulitins</a></li><li><a class="el" href="page_mi_eg.html#sect_mi_eg_06">Execute CL Commands Using EMI Builtin system</a></li></ul>
<h2><a class="anchor" name="sect_mi_eg_01">
Print OS Version Information</a></h2>
To retieve OS version (Licensed Internal Code version release modification) of an i5/OS installation, use the MATMATR instruction with option hex 020C.<p>
<div class="fragment"><pre class="fragment"><span class="comment">/* *</span>
<span class="comment"> * @file sep10.emi</span>
<span class="comment"> *</span>
<span class="comment"> * @attention applicable on V5R4 and later </span>
<span class="comment"> */</span>

dcl dd os-version char(6) bas(.os-version) ; 

entry *(plist-main) ext         ; 

dcl dd mat-tmpl <span class="keywordtype">char</span>(16) auto        ;
dcl spcptr .mat-tmpl auto init(mat-tmpl) ; 
        dcl dd bytes-in bin(4) def(mat-tmpl) pos(1) init(16) ; 
        dcl dd bytes-available bin(4) def(mat-tmpl) pos(5) ; 
        dcl dd lic-version <span class="keywordtype">char</span>(6) def(mat-tmpl) pos(9) ; 

        cpynv bytes-in, 16             ;
        cpybrep os-version, ' '        ;
        matmatr .mat-tmpl, x"020C" ; 
        cpybla os-version, lic-version ; 

dcl dd len bin(2) auto          ;
        triml len, os-version   ;
        %sendmsg(os-version, len) ;

brk 'RTN'                       ;
        rtx *                   ; 
pend                            ;
</pre></div><h2><a class="anchor" name="sect_mi_eg_02">
List Activation Groups of One's Current Job</a></h2>
To list activation groups of the current job, we need the following two MI instructions:<ul>
<li>Materialize Process Activation Groups (MATPRAGP)</li><li>Materialize Activation Group Attributes (MATAGPAT)</li></ul>
<p>
Download source file <a href="src/sep5.emi">sep5.emi</a><p>
<div class="fragment"><pre class="fragment">
entry * ext                     ;

dcl spcptr tmpl-ptr auto        ;
dcl spc tmpl-t bas(tmpl-ptr)    ;
        dcl dd bytes-in bin(4) dir ;
        dcl dd bytes-out bin(4) dir ;
        dcl dd agp-num bin(4) dir   ;

        <span class="comment">/* get number of activation groups */</span>
dcl dd bytes-needed bin(4) auto       ;
        modasa tmpl-ptr, 12     ;
        cpynv bytes-in, 12      ;
        matpragp tmpl-ptr       ;
        cpynv bytes-needed, bytes-out ;
        modasa tmpl-ptr, -12          ;

        modasa tmpl-ptr, bytes-needed ;
        cpynv bytes-in, bytes-needed  ;
        matpragp tmpl-ptr             ;

        <span class="comment">/* print agp names */</span>
dcl dd agp-info-0 <span class="keywordtype">char</span>(136) auto bdry(16)     ;
dcl spcptr agp-info-ptr auto init(agp-info-0) ;
dcl spc agp-info-spc bas(agp-info-ptr)        ;
        dcl dd agp-bytes-in bin(4) dir        ;
        dcl dd agp-bytes-out bin(4) dir       ;
        dcl dd * <span class="keywordtype">char</span>(8) dir                  ;
        dcl dd * <span class="keywordtype">char</span>(48) dir                 ;
        dcl dd agp-name <span class="keywordtype">char</span>(30) dir          ;
dcl dd ind pkd(3,0) auto                      ;
dcl dd num bin(4) auto                        ;
dcl dd agp-mark bin(4) unsgnd bas(tmpl-ptr)   ;
dcl dd agp-mark-ch <span class="keywordtype">char</span>(4) bas(tmpl-ptr)   ;
dcl dd msg <span class="keywordtype">char</span>(64) auto                      ;
dcl dd cvtnc-tmpl <span class="keywordtype">char</span>(7) auto init(x'02000300000000') ;

        cpynv ind, 0            ;
        cpynv num, agp-num      ;
        addspp tmpl-ptr, tmpl-ptr, 12 ;
        cpynv agp-bytes-in, 136       ;
        cpyblap msg, 'Activation groups of current job:', ' ' ;
        %sendmsg(msg, 33)       ;
        cpyblap msg, "    Num  Activation Group Name          Activation Mark", ' ' ;
        %sendmsg(msg, 64)       ;

agp-loop:
        addn(s) ind, 1                         ;
        cmpnv(b) ind, num / hi(end-agp-loop)   ;
        matagpat agp-info-ptr, agp-mark, x'00' ; <span class="comment">/* retieve basic actgrp info */</span>

        cpybrep msg, ' '        ;
        cvtnc msg(5:3), ind, cvtnc-tmpl ;
        cpybla msg(10:30), agp-name ;
        cvthc msg(41:8), agp-mark-ch ;
        %sendmsg(msg, 64)  ;

        addspp tmpl-ptr, tmpl-ptr, 4 ;
        b agp-loop              ;
end-agp-loop:
        <span class="comment">/* free tmpl-ptr */</span>
        subn bytes-needed, 0, bytes-needed ;
        modasa tmpl-ptr, bytes-needed ;

        rtx *                   ;
pend                            ;

</pre></div><p>
Run program SEP5 <div class="fragment"><pre class="fragment">&gt; call sep5                                              
  Activation groups of current job:                      
      Num  Activation Group Name          Activation Group Mark
      001                                 00000001       
      002                                 00000002       
      003  QTESAGRP                       00000241       
      004  QLGLOCAL                       00000251       
</pre></div><h2><a class="anchor" name="sect_mi_eg_03">
List Activation Entries in a Specific Activation Group</a></h2>
The following program accepts a 4 bytes activation group mark as input parameter, and prints information of each activation entry in the specified activation group. The output includes program library, program name, invocation count, and activation status of each activation entry. Note that only programs currently on the call-stack of a thread belongs to the specified activation group could have non-zero invocation counts.<p>
<div class="fragment"><pre class="fragment"><span class="comment">/* *</span>
<span class="comment"> * @file sep6.mi</span>
<span class="comment"> *</span>
<span class="comment"> * list activation entries in a activation group</span>
<span class="comment"> *</span>
<span class="comment"> * @param[in] arg-mark, bin(4) unsgnd, activation group mark</span>
<span class="comment"> */</span>

dcl spcptr agp-mark-ptr parm    ;
dcl ol pl-main(agp-mark-ptr) parm ext ;

entry *(pl-main) ext            ;

dcl dd agp-mark bin(4) unsgnd bas(agp-mark-ptr) ;

dcl spcptr agp-info-ptr auto            ;
dcl spc agp-info-spc bas(agp-info-ptr)        ;
        dcl dd agp-bytes-in bin(4) dir        ;
        dcl dd agp-bytes-out bin(4) dir       ;
        dcl dd * <span class="keywordtype">char</span>(8) dir                  ;
dcl dd len bin(4) auto                        ;
dcl dd act-count bin(4) unsgnd bas(agp-info-ptr) pos(109) ;
dcl dd num-act bin(4) unsgnd auto                         ;

        <span class="comment">/* get activation count */</span>
        modasa agp-info-ptr, 16                ;
        cpynv agp-bytes-in, 16                 ;
        matagpat agp-info-ptr, agp-mark, x'00' ;
        cpynv len, agp-bytes-out               ;
        modasa agp-info-ptr, -16               ;

        modasa agp-info-ptr, len ;
        cpynv agp-bytes-in, len  ;
        matagpat agp-info-ptr, agp-mark, x'00' ;

        cpynv num-act, act-count ;
        subn len, 0, len        ;
        modasa agp-info-ptr, len ;

        <span class="comment">/* list activation marks */</span>
        modasa agp-info-ptr, 16                ;
        cpynv agp-bytes-in, 16                 ;
        matagpat agp-info-ptr, agp-mark, x'02' ;
        cpynv len, agp-bytes-out               ;
        modasa agp-info-ptr, -16               ;

        modasa agp-info-ptr, len ;
        cpynv agp-bytes-in, len  ;
        matagpat agp-info-ptr, agp-mark, x'02' ;

        <span class="comment">/* matactat */</span>
<span class="comment">/* basic activation info */</span>
dcl dd act-info <span class="keywordtype">char</span>(72) auto bdry(16) ;
dcl spcptr act-info-ptr auto init(act-info) ;
dcl spc act-info-t bas(act-info-ptr)        ;
        dcl dd act-bytes-in bin(4) dir      ;
        dcl dd act-bytes-out bin(4) dir     ;
        dcl dd * <span class="keywordtype">char</span>(8) dir                ;
        dcl sysptr act-pgm dir              ;
        dcl dd * bin(4) unsgnd dir          ; <span class="comment">/* activation mark: act-mark */</span>
        dcl dd * bin(4) unsgnd dir          ; <span class="comment">/* activation group mark */</span>
        dcl dd inv-count bin(4) unsgnd dir  ; 
        dcl dd ssf-count bin(4) unsgnd dir  ;
        dcl dd pgm-type <span class="keywordtype">char</span>(1) dir         ;
        dcl dd act-status <span class="keywordtype">char</span>(1) dir       ; <span class="comment">/* bit 0: 0=inactive, 1=active */</span>
        dcl dd tgt-agp <span class="keywordtype">char</span>(1) dir          ;
        dcl dd * <span class="keywordtype">char</span>(1) dir                ;
        dcl dd dep-act-count bin(4) unsgnd dir ;
        dcl dd act-mark-<span class="keywordtype">long</span> <span class="keywordtype">char</span>(8) dir    ;
        dcl dd agp-mark-<span class="keywordtype">long</span> <span class="keywordtype">char</span>(8) dir    ;

dcl dd ind bin(4) auto          ;
dcl spcptr act-mark-ptr auto    ;
dcl dd act-mark bin(4) unsgnd bas(act-mark-ptr) ;
dcl dd msg <span class="keywordtype">char</span>(64) auto        ;
dcl dd cvtnc-attr <span class="keywordtype">char</span>(7) auto init(x'02000200000000') ;
        cpynv ind, 0            ;
        cpynv act-bytes-in, 72  ;
        setsppfp act-mark-ptr, agp-info-ptr ;
        addspp act-mark-ptr, act-mark-ptr, 16 ;

        cpynv matptr-bytes-in, 77 ;

        cpyblap msg(1:10), "Library", " " ;
        cpyblap msg(11:10), "Program", " " ;
        cpyblap msg(21:10), "Inv-Cnt", " " ;
        cpyblap msg(32:10), "Act-sts", " " ;
        %sendmsg(msg, 64)                          ;

        cpybrep msg, ' '        ;

activation-loop:

        addn(s) ind, 1          ;
        cmpnv(b) ind, num-act / hi(end-loop) ;

        matactat act-info-ptr, act-mark, x'00' ;
brk 'CHK'                       ;
        <span class="comment">/* check inv-count, act-pgm */</span>
        matptr matptr-tmpl-ptr, act-pgm ;

        cpybla msg(1:10), matptr-ctx-name ;
        cpybla msg(11:10), matptr-pgm-name ;
        cvtnc  msg(28:2), inv-count, cvtnc-attr ;
        cmpbla(b) act-status, '0' / neq(=+3) ;
        cpyblap msg(31:10), "Inactive", " "  ;
        b =+2                   ;
:
        cpyblap msg(31:10), "Active", ' ' ;
:
        %sendmsg(msg, 64)           ;
recover:
        addspp act-mark-ptr, act-mark-ptr, 4 ;
        b activation-loop       ;
end-loop:

brk 'END'                       ;

        subn len, 0, len        ;
        modasa agp-info-ptr, len ;
        rtx *                   ;

<span class="comment">/* template of MATPTR */</span>
dcl dd matptr-tmpl <span class="keywordtype">char</span>(77) auto ;
dcl spcptr matptr-tmpl-ptr auto init(matptr-tmpl) ;
dcl spc matptr-tmpl-t bas(matptr-tmpl-ptr)        ;
        dcl dd matptr-bytes-in bin(4) dir         ;
        dcl dd matptr-bytes-out bin(4) dir        ;
        dcl dd matptr-ptr-type <span class="keywordtype">char</span>(1) dir        ;
        dcl dd matptr-ctx-type <span class="keywordtype">char</span>(2) dir        ;
        dcl dd matptr-ctx-name <span class="keywordtype">char</span>(30) dir       ;
        dcl dd matptr-pgm-type <span class="keywordtype">char</span>(2) dir        ;
        dcl dd matptr-pgm-name <span class="keywordtype">char</span>(30) dir       ;
        dcl dd matptr-ptr-auth <span class="keywordtype">char</span>(2) dir        ;
        dcl dd matptr-ptr-tgt <span class="keywordtype">char</span>(2) dir         ;

dcl excm ex excid(h'0000') bp(on-error) imd cv('MCH') ;

on-error:       

dcl dd ex-info <span class="keywordtype">char</span>(16) auto init('Oops :p') ;
        %sendmsg(ex-info, 16)   ;
        b recover               ; <span class="comment">/* 用法有问题 here-today */</span>

pend                            ;
<span class="comment">/* eof - sep6.mi */</span>
</pre></div><p>
Run program SEP6 <div class="fragment"><pre class="fragment"><span class="comment">/* check activation entries in the second *DFTACTGRP */</span>
&gt; call sep6 x<span class="stringliteral">'00000002'</span>                 
  Library   Program   Inv-Cnt    Act-sts
  QSHELL    QZSHQSHC         00 Active  
  QSHELL    QZSHBASE         00 Active  
  QSYS      QC2UTIL1         00 Active  
  QSYS      QC2POSIX         00 Active  
  QSYS      QLEAWI           00 Active  
  QSYS      QP0LLIB1         00 Active  
  QSYS      QP0LLIB2         00 Active  
  QSYS      QP0ZCPA          00 Active  
  QSYS      QP0ZTRML         00 Active  
  QSYS      QSYPAPI          00 Active  
<span class="comment">/* ... ... */</span>
  QRPLOBJ   Q5DA70AFBC       00 Active
  LSBIN     SEP6             01 Active
</pre></div><h2><a class="anchor" name="sect_mi_eg_04">
Use EMI Includes</a></h2>
Try to delete a nonexistent *USRSPC. <div class="fragment"><pre class="fragment">
entry * ext                     ;

dcl dd spc char(20) auto init('SEP1      LSBIN') ;

        <span class="comment">/* try to delete a nonexistent *USRSPC */</span>
        setspp emi-qusdltus-al-usrspc, spc ;
        cpynv emi-ec-bytes-in, emi-qusec-len ;
        setsppfp emi-qusdltus-al-ec, emi-qusec-ptr ;
        callx emi-qusdltus, emi-qusdltus-al, * ;

brk 'CHK-EC'                    ;
        cmpnv(b) emi-ec-bytes-out, 0 / nhi(farewell) ;
        %sendmsg(emi-ec-exid, 7)                  ;

farewell:       
  rtx *                   ;

/include qusec.emi              ;
/include qusdltus.emi           ;

pend                            ;
</pre></div><h2><a class="anchor" name="sect_mi_eg_05">
Operate Stream Files using EMI Stream File Bulitins</a></h2>
Write a stream file. <div class="fragment"><pre class="fragment"><span class="comment">/* *</span>
<span class="comment"> * @file sep14.emi</span>
<span class="comment"> *</span>
<span class="comment"> */</span>

entry * ext                     ;

dcl dd fd bin(4) auto           ;
dcl dd path-name <span class="keywordtype">char</span>(64) auto  ;
dcl dd file-mode bin(4) auto init(h'180') ;

        cpyblap path-name, '/home/ljl/923', x'00' ;
        cpynv fd, %stmf-creat(path-name, file-mode) ;
brk 'CRT'                       ;

dcl dd str <span class="keywordtype">char</span>(8) auto init('morning!') ;
dcl dd written bin(4) auto               ;

        cpynv written, %stmf-write(fd, str, 8) ;
        cpybla str, 'MoRnInG!'                 ;
        %stmf-write(fd, str, 8) ;

brk 'WRT'                       ;
dcl dd rtn bin(4) auto          ;
        cpynv rtn, %stmf-close(fd) ;

brk 'CLS'                       ;
        rtx *                   ;

pend                            ;
</pre></div><p>
Check result *STMF <div class="fragment"><pre class="fragment">&gt; wrklnk <span class="stringliteral">'/home/ljl/923'</span>

 ************Beginning of data**************
morning!MoRnInG!                            
 ************End of Data********************
</pre></div><h2><a class="anchor" name="sect_mi_eg_06">
Execute CL Commands Using EMI Builtin %system</a></h2>
EMI provides a builtin, %system to execute CL commands. See <a class="el" href="page_mic_builtin.html#sect_mic_builtin_system">system (execute a CL command)</a> for details. The following program uses the %system builtin to execute CL command CRTLIB to create a library.<p>
<div class="fragment"><pre class="fragment"><span class="comment">/* *</span>
<span class="comment"> * @file sep19.emi</span>
<span class="comment"> *</span>
<span class="comment"> * usage example of EMI builtin %system</span>
<span class="comment"> */</span>

entry * ext                     ;

dcl dd cmd char(64) auto        ;
dcl dd rtn bin(4) auto          ;

        cpyblap cmd,
          "CRTLIB LIB(HUHUHAHA) TEXT('Sun Wukong and Juliet')",
          x'00'                 ;
        cpynv rtn, %system(cmd) ;

        <span class="comment">/* has the library been created? */</span>
        cmpnv(b) rtn, 0 / neq(failed) ;
        cpyblap cmd,
          "WRKLIB HUHUHAHA",
          x"00"                 ;
        %system(cmd)            ;
        b farewell              ;
failed:
        cpyblap cmd,
          "CRTLIB command failed.",
          ' '                   ;
dcl dd len bin(2) auto          ;
        triml len, cmd, ' '     ;
        %sendmsg(cmd, len)      ;

farewell:       
        rtx *                   ;
pend                            ;
<span class="comment">/* eof */</span>
</pre></div><p>
Call program SEP19. <div align="center">
<img src="mi-eg-1.png" alt="mi-eg-1.png">
<p><strong>Program SEP19 issues CL command WRKLIB after creating library HUHUHAHA by executing CL command CRTLIB</strong></p></div>
<h2><a class="anchor" name="sect_mi_eg_07">
sect_mi_eg_07</a></h2>
</div>
<hr size="1">

<a href="http://sourceforge.net/donate/index.php?group_id=254578"><img src="http://images.sourceforge.net/images/project-support.jpg" width="88" height="32" border="0" alt="Support This Project" /> </a>

<address style="text-align: right;"><small>Generated on Tue May 10 19:55:05 2011 for i5/OS Programmer's Toolkit: MIC - The Machine Instruction Language Compiler by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border="0"></a> 1.5.9  </small></address>
</body>
</html>
