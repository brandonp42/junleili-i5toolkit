<HTML>
  <HEAD>
    <meta http-equiv="Content-Type" content="text/html;charset=UTF-8">
    <TITLE>i5/OS Programmer's Toolkit - MI/EMI Programmer's Guide</TITLE>
    <link href="tabs.css" rel="stylesheet" type="text/css">
    <link href="doxygen.css" rel="stylesheet" type="text/css">
    <link href="docs.css" rel="stylesheet" type="text/css">

    <table width="100%" border="0" cellspacing="0" cellpadding="0">
      <tr>
        <td align="left">
          <a href="http://sourceforge.net/donate/index.php?group_id=254578"><img src="http://images.sourceforge.net/images/project-support.jpg" width="88" height="32" border="0" alt="Support This Project" /> </a>
        </td>
        <td align="right">
          <a href="http://sourceforge.net/projects/i5toolkit"><img src="http://sflogo.sourceforge.net/sflogo.php?group_id=254578&amp;type=13" width="120" height="30" alt="Get i5/OS Programmer's Toolkit at SourceForge.net. Fast, secure and Free Open Source software downloads" /></a>
        </td>

      </tr>
    </table>

  </HEAD>
  <body>
<!-- Generated by Doxygen 1.5.9 -->
<div class="navigation" id="top">
  <div class="tabs">
    <ul>
      <li><a href="index.html"><span>Main&nbsp;Page</span></a></li>
      <li class="current"><a href="pages.html"><span>Related&nbsp;Pages</span></a></li>
    </ul>
  </div>
</div>
<div class="contents">
<h1><a class="anchor" name="page_mic_cn">i5/OS Programmer's Toolkit: EMI (扩展i5/OS机器接口语言) 和 MIC (MI/EMI编译器) </a></h1>返回 i5/OS Programmer's Toolkit <a href="../index.html">主页</a><p>
本页的翻译:<ul>
<li>English: <a href="index.html">i5/OS Programmer's Toolkit: MIC - The Machine Interface Language Compiler </a></li></ul>
<p>
MI (i5/OS Machine Interface)是i5/OS应用程序与Licensed Internal Code (LIC) 之间的逻辑接口层。MI存在2种变体: OMI (original MI) 和 NMI (new MI)。这里我们提到的MI指OMI。<p>
EMI (Extended i5/OS Machine Interface Language) 是什么，不是什么<ul>
<li>EMI是i5/OS机器接口语言的语言扩展<br>
 EMI通过编译器directives和可扩展的builtin库对i5/OS机器接口语言 进行了扩展；EMI的设计准则是在保留传统MI语言灵活的语言特性 同时，提高MI代码的复用性，提高MI程序的开发效率</li><li>EMI不是一种新的编程语言<br>
 所有EMI代码最终被转换为OMI语言编译器API QPRCRTPG可识别的 MI代码，由API QPRCRTPG完成编译</li><li>EMI是系统程序员了解i5/OS这个复杂的操作系统的一条捷径</li></ul>
<p>
<b>这里的内容</b><ul>
<li><a class="el" href="page_mic_cn.html#sect_mic_download_cn">下载MIC</a></li><li><a class="el" href="page_mic_cn.html#sect_mic_hello_cn">EMI的Hello World!示例</a></li><li><a class="el" href="page_mic_cn.html#sect_mic_interface_cn">MIC命令接口描述</a><ul>
<li><a class="el" href="index.html#ss_mic_interface_cl">CL Command MIC</a></li><li><a class="el" href="index.html#ss_mic_interface_sh">QShell Command mic</a></li><li><a class="el" href="index.html#ss_mic_interface_demo">Usage Example of MIC Commands</a></li></ul>
</li><li><a class="el" href="page_mic_cn.html#sect_mic_syntax_spec_cn">EMI语法规格说明</a></li><li><a class="el" href="page_emi_directives.html">EMI Compiler Directives</a></li><li><a class="el" href="index.html#sect_mic_convention">MIC Conventions</a></li><li><a class="el" href="page_mic_builtin.html">Specifications of EMI Builtins</a></li><li><a class="el" href="page_mic_compiler_inc.html">Compiler Includes</a></li><li><a class="el" href="page_mi_eg.html">Example Programs for MI/EMI Novice</a></li><li><a class="el" href="page_mic_cn.html#sect_mic_other_readings_cn">相关读物及链接</a></li><li><a class="el" href="page_mic_cn.html#sect_mic_contact_cn">联系我们</a></li><li><a href="../art/page_using_q_cn.html#sect_using_q_about_me">关于作者</a></li></ul>
<h2><a class="anchor" name="sect_mic_download_cn">
下载MIC</a></h2>
MIC及i5/OS Programmer's Toolkit所有子项目各版本的的代码， 文档及二进制组件可以由这里获取<ul>
<li><a href="http://sourceforge.net/projects/i5toolkit/files/">http://sourceforge.net/projects/i5toolkit/files/</a></li></ul>
<h2><a class="anchor" name="sect_mic_hello_cn">
EMI的Hello World!示例</a></h2>
假设程序员编写了下面的2个EMI源文件，分别保存为流文件 /home/ljl/tmp/hello.emi和源物理文件(Source PF)的成员 (Member)，SRCLIB/MISRC(WORLD)。编译后，程序HELLO调用WORLD随机取得一种编 程语言的名字，然后调用builtin sendmsg()输出'Hello + 语言名'。<ul>
<li>存为流文件的源码 /home/ljl/tmp/hello.emi <div class="fragment"><pre class="fragment">
entry hello-main ext            ;

dcl sysptr pgm-world <span class="keyword">auto</span> init(<span class="stringliteral">"WORLD"</span>, type(pgm)) ;
dcl dd msg char(32) auto                           ;
dcl dd len bin(4) auto                             ;
dcl spcptr msg-ptr auto init(msg)                  ;
dcl ol argl-world(msg-ptr) arg                     ;

brk 'INIT'                             ;
        cpyblap msg, 'Hello, ', ' '    ;
        addspp msg-ptr, msg-ptr, 7     ;
        callx pgm-world, argl-world, * ;

brk 'SEND_MSG'                  ;
        triml len, msg, ' '     ;
        %sendmsg(msg, len)      ;

brk 'END'                       ;
        rtx *                   ;
pend;
<span class="comment">/* eof - hello.mi */</span>
</pre></div></li><li>存为库文件系统源物理文件(Source PF)成员(Member)的源码 SRCLIB/MISRC(WORLD) <div class="fragment"><pre class="fragment">
dcl spcptr .world parm           ;
dcl ol pl-world(.world) parm ext ;
entry * ext                     ;

dcl dd world <span class="keywordtype">char</span>(8) bas(.world) ;
dcl dd words(0:3) <span class="keywordtype">char</span>(8) init(
        *(0)'ILE RPG',
        'COBOL',
        'Java',
        'MI'
) ;

dcl dd buf <span class="keywordtype">char</span>(8) auto         ;
dcl dd i bin(2) unsgnd def(buf) pos(7) ;

        matmdata buf, x'0000'   ;
        div(s) i, 16384         ;
        cpyblap world, words(i), ' ' ;
brk 'END'                       ;
        rtx *                   ;
pend;
<span class="comment">/* eof - world.mi */</span>
</pre></div></li><li>编译<ul>
<li>使用QShell命令mic，由流文件源码/home/ljl/tmp/hello.emi编译程序HELLO <div class="fragment"><pre class="fragment">     qsh
     &gt; cd /home/ljl/tmp
     &gt; mic -q*replace hello.emi             
       mic:  -- program HELLO      is placed in library LSBIN
</pre></div></li><li>在CL环境下使用CL命令MIC，由库文件系统源码SRCLIB/MISRC(WORLD)编译程序WORLD <div class="fragment"><pre class="fragment">     &gt; MIC PGM(WORLD)
           SRCPATH('/qsys.lib/srclib.lib/misrc.file/world.mbr')
           OPTION(*REPLACE)   <span class="comment">/* 替换已存在同名程序对象 */</span>
       mic:  -- program WORLD      is placed in library LSBIN.
</pre></div></li></ul>
</li><li>在CL环境下执行程序HELLO <div class="fragment"><pre class="fragment">    &gt; CALL PGM(HELLO)
      Hello, COBOL   
    &gt; CALL PGM(HELLO)
      Hello, MI      
    &gt; CALL PGM(HELLO)
      Hello, ILE RPG 
    &gt; CALL PGM(HELLO)
      Hello, ILE RPG 
</pre></div></li></ul>
<h2><a class="anchor" name="sect_mic_interface_cn">
MIC命令接口描述</a></h2>
MIC支持以CL命令方式调用或以QShell命令方式调用。CL命令为I5TOOLKIT/MIC， QShell命令为/usr/bin/mic或/usr/bin。这里的内容<ul>
<li><a class="el" href="index.html#ss_mic_interface_cl">CL Command MIC</a></li><li><a class="el" href="index.html#ss_mic_interface_sh">QShell Command mic</a></li><li><a class="el" href="index.html#ss_mic_interface_demo">Usage Example of MIC Commands</a></li></ul>
<h3><a class="anchor" name="ss_mic_interface_cl_cn">
CL命令MIC</a></h3>
MIC的CL命令为I5TOOLKIT/MIC；使用时需要把库I5TOOLKIT添加到库列表中。 CL命令MIC参数如下: <table border="1" cellspacing="3" cellpadding="3">
<tr bgcolor="silver">
<td>参数名 </td><td>含义  </td></tr>
<tr>
<td>Program (PGM) </td><td>编译产出的程序对象名及库名；库名默认为*CURLIB，当前库 </td></tr>
<tr>
<td>Source path name (SRCPATH) </td><td>源文件路径名，见注释1， 注释2 </td></tr>
<tr>
<td>Text description (TEXT) </td><td>程序的文字描述 </td></tr>
<tr>
<td>Output printer file (OUTPUT) </td><td>输出编译器列示信息时使用的打印文件(*PRTF)；默认为*LIBL/QSYSPRT。见注释3 </td></tr>
<tr>
<td>Public authority (AUT) </td><td>公共权限；默认为*ALL </td></tr>
<tr>
<td>Include directories (INCDIR) </td><td>包含路径，最多15个；可以指定库文件系统，流文件系统的绝对路径或相对路径 </td></tr>
<tr>
<td>Compiler options (OPTION) </td><td>编译选项；参考IBM给出的i5/OS机器接口语言规格说明 <a href="http://publib.boulder.ibm.com/infocenter/iseries/v5r4/index.jsp?topic=/apis/qprcrtpg.htm">Create Program (QPRCRTPG) API</a> </td></tr>
<tr>
<td>注释1.</td><td>MIC支持流文件系统源和数据库文件系统源。 对于流文件系统源，SRCPATH参数直接使用流文件(*STMF)的IFS路径名，如：/home/ljl/misrc/hello.emi； 当使用数据库文件系统存储源时，要使用源物理文件(source PF)，指定路径时要使用 /qsys.lib 格式，如：/qsys.lib/srclib.lib/misrc.file/world.emi。 对源物理文件(source PF)使用CL命令DSPFD时，可以看到文件的File type (FILETYPE)为'*SRC'(而数据物理文件为'*DATA')。  </td></tr>
<tr>
<td>注释2. </td><td>MIC在定位源文件时支持绝对路径和相对路径。结合使用当前路径和 源文件相对路径名可以带来许多方便。通过QShell使用MIC时，当前路径为当前工作路径； 通过CL命令使用MIC时，可以用CL命令CHDIR或CHGCURDIR修改当前路径，可以用CL命令 DSPCURDIR查看当前路径。  </td></tr>
<tr>
<td>注释3. </td><td>如果希望MIC输出编译列示信息需要指定*LIST选项。 编译列示信息输出为spooled file，spooled file名称为 OUTPUT参数指定的Printer File名称。  </td></tr>
</table>
<h3><a class="anchor" name="ss_mic_interface_sh_cn">
QShell命令mic</a></h3>
MIC的QShell接口为QShell命令/usr/bin/mic或/usr/bin。使用-h选项执行mic 可以显示简要帮助信息。 <div class="fragment"><pre class="fragment">&gt; mic -h                                          
  Usage: mic [options] file                       
  Options:                                        
          -v      Verbose
          -V      Show version information
          -h      Show help information           
          -o      Name of created program <span class="keywordtype">object</span>
          -t      Text description                
          -l      Output printer file name        
          -a      Public authority                
          -I      Include path                    
          -q      Compiler options
          -L      Library name of created program <span class="keywordtype">object</span>
                                                  
  Report bugs to junleili-cn@users.sourceforge.net
</pre></div><p>
QShell命令mic的选项及含义如下: <table border="1" cellspacing="3" cellpadding="3">
<tr bgcolor="silver">
<td>选项名 </td><td>含义  </td></tr>
<tr>
<td>-h </td><td>显示帮助信息 </td></tr>
<tr>
<td>-v </td><td>verbose, 当指定了-q*list 显示编译列示信息 </td></tr>
<tr>
<td>-V </td><td>显示版本信息 </td></tr>
<tr>
<td>-o program-name </td><td>指定程序对象名；如不指定则使用输入文件名作为程序对象名 </td></tr>
<tr>
<td>-t text </td><td>指定程序文字描述 </td></tr>
<tr>
<td>-l printer-file </td><td>指定输出编译器列示信息时使用的打印文件(*PRTF)；如不指定使用*LIBL/QSYSPRT。 </td></tr>
<tr>
<td>-a public-authority </td><td>公共权限；默认为*ALL </td></tr>
<tr>
<td>-I include-path </td><td>包含路径；可以指定最多15个 </td></tr>
<tr>
<td>-q compiler-option </td><td>编译选项；参考IBM给出的i5/OS机器接口语言规格说明 <a href="http://publib.boulder.ibm.com/infocenter/iseries/v5r4/index.jsp?topic=/apis/qprcrtpg.htm">Create Program (QPRCRTPG) API</a>  </td></tr>
<tr>
<td>-L library-name </td><td>程序所在库名称。 如果环境变量OUTPUTDIR存在，使用OUTPUTDIR的值。 如果环境变量OUTPUTDIR不存在，使用作业当前库。  </td></tr>
</table>
<dl class="remark" compact><dt><b>Remarks:</b></dt><dd>如果未指定<em>source-file-name</em>，MIC由标准输入读取源码。 由标准输入读取源码时，如果未指定-o选项，MIC使用a.out作为输出程序名。</dd></dl>
<h3><a class="anchor" name="ss_mic_interface_demo_cn">
MIC命令使用示例</a></h3>
更多示例请参考 <a href="page_mic_eg.html">Best Practices in Using MIC</a>。<p>
<b>使用相对路径指定源文件和包含路径</b><br>
 假设库文件系统源文件为 SRCLIB/MISRC(HELLO)， 被包含库文件系统源文件为 SRCLIB/MISRC(UTIL_INC)，CL命令MIC参数可以按如下指定: <div class="fragment"><pre class="fragment">&gt; CHGCURDIR DIR(<span class="stringliteral">'/qsys.lib/srclib.lib/misrc.file'</span>)                         
  Current directory changed.                                               
&gt; MIC PGM(HELLO)
      SRCPATH(hello.mbr)  <span class="comment">/* 相对路径名 */</span>
      TEXT('using relative path name')
  mic:  -- program HELLO      is placed in library *CURLIB.                
</pre></div> 上面的示例中MIC在当前路径 /qsys.lib/srclib.lib/misrc.file 下 定位到目的源文件hello.mbr时，以及被包含源文件util_inc.mbr。<p>
<b>混合使用库文件系统源文件和流文件系统源文件</b><br>
 假设目的源文件为库文件系统源文件为 SRCLIB/MISRC(HELLO)， 被包含源文件分别在流文件系统目录 /home/ljl/mi-inc, /home/ljl/mi-inc/sub-dir 下，CL命令MIC参数可以按如下指定: <div class="fragment"><pre class="fragment">&gt; CHDIR DIR(<span class="stringliteral">'/home/ljl/mi-src'</span>)
  Current directory changed.   
&gt; MIC PGM(HELLO)
      SRCPATH('/qsys.lib/srclib.lib/misrc.file/hello.mbr')
      INCDIR('sub-dir')
      OPTION(*REPLACE)                                            
  mic:  -- program HELLO      is placed in library *CURLIB.                
</pre></div> 上面的示例中MIC在当前路径 /home/ljl/mi-src 和 /home/ljl/mi-inc/sub-dir 下定位到被包含源文件。<p>
<b>在QShell环境下输出编译列示信息</b><br>
 在QShell环境下输出编译列示信息，需要同时指定-v选项和-q*list选项，如 <div class="fragment"><pre class="fragment">qsh
&gt; mic -v -q*replace -q*list hello.emi
</pre></div><p>
<b>在QShell环境通过标准输入录入源</b><br>
 在QShell环境下调用mic命令，如果不指定输入源文件，MIC由标准输入 读取源。如果未指定-o选项，MIC使用a.out作为输出程序名。 <div class="fragment"><pre class="fragment">&gt; mic &lt;&lt; eof
  &gt;
&gt; entry * ext;
  &gt;
&gt; dcl dd msg char(32) auto init('happy birthday:)');
  &gt;
&gt; dcl dd len bin(2) auto;
  &gt;
&gt;     triml len, msg, ' ';
  &gt;
&gt;     %sendmsg(msg, len);
  &gt;
&gt;     rtx *;
  &gt;
&gt; pend;
  &gt;
&gt; eof
  mic:  -- program A.OUT      is placed in library LSBIN
  $
&gt; system "call a.out" <span class="preprocessor"># 执行程序A.OUT</span>
<span class="preprocessor"></span>         :
  happy birthday:)
  $
</pre></div><h2><a class="anchor" name="sect_mic_syntax_spec_cn">
EMI语法规格说明</a></h2>
EMI支持i5/OS机器接口语言语法，并对i5/OS机器接口语言语法进行了扩展。 关于i5/OS机器接口语言语法，参考 IBM给出的i5/OS机器接口语言规格说明 <a href="http://publib.boulder.ibm.com/infocenter/iseries/v5r4/index.jsp?topic=/apis/qprcrtpg.htm">Create Program (QPRCRTPG) API</a><p>
<ul>
<li>与i5/OS机器接口语言语法的区别是:<ul>
<li>EMI不区分代码的大小写，除字符常量以外的所有符号最终被转换为大写</li><li>符号应避免以'@'或'.@'开头，以避免与builtin使用的符号重复</li></ul>
</li></ul>
<p>
<ul>
<li>EMI compiler directives, 参考 <a class="el" href="page_emi_directives.html">EMI Compiler Directives</a>.</li></ul>
<p>
<ul>
<li>内置函数支持参考 <a class="el" href="page_mic_builtin.html">Specifications of EMI Builtins</a></li></ul>
<p>
<ul>
<li>其他注意事项:<ul>
<li>EMI支持单行或多行注释，注释使用 '/','*' 开始，使用 '*','/' 结束；不支持注释嵌套；如: <div class="fragment"><pre class="fragment">     <span class="comment">/* single-line comment */</span>
     <span class="comment">/*</span>
<span class="comment"> multi-line comment</span>
<span class="comment"></span>
<span class="comment"> ... ...</span>
<span class="comment">      */</span>
</pre></div></li><li>EMI最多支持15层源文件包含，应注意包含深度，并避免递归包含。如， 源文件直接或间接包含自身。</li></ul>
</li></ul>
<h2><a class="anchor" name="sect_mic_other_readings_cn">
相关读物及链接</a></h2>
<ul>
<li>内置函数说明见 <a class="el" href="page_mic_builtin.html">Specifications of EMI Builtins</a></li><li><a class="el" href="page_mic_eg.html">Best Practices in Using MIC</a> (coming soon ...)</li><li><a class="el" href="page_mi_eg.html">Example Programs for MI/EMI Novice</a></li><li>IBM给出的i5/OS机器接口语言规格说明 <a href="http://publib.boulder.ibm.com/infocenter/iseries/v5r4/index.jsp?topic=/apis/qprcrtpg.htm">Create Program (QPRCRTPG) API</a></li><li>IBM关于Machine Interface Instructions的官方文档: <a href="http://publib.boulder.ibm.com/infocenter/iseries/v5r4/index.jsp?topic=/rzatk/mitoc.htm">i5/OS Machine Interface </a></li></ul>
<h2><a class="anchor" name="sect_mic_contact_cn">
联系我们</a></h2>
如果您对EMI/MIC或i5/OS Programmer's Toolkit项目的其他子项目及其产品 有改进建议，请通过以下方式告诉我们:<ul>
<li>我们的电子邮件地址: <a href="mailto:junleili-cn@users.sourceforge.net">junleili-cn@users.sourceforge.net</a>.</li><li>项目论坛地址: <a href="https://sourceforge.net/forum/forum.php?forum_id=922956">https://sourceforge.net/forum/forum.php?forum_id=922956</a> </li></ul>
</div>
<hr size="1">

<a href="http://sourceforge.net/donate/index.php?group_id=254578"><img src="http://images.sourceforge.net/images/project-support.jpg" width="88" height="32" border="0" alt="Support This Project" /> </a>

<address style="text-align: right;"><small>Generated on Tue May 10 19:55:05 2011 for i5/OS Programmer's Toolkit: MIC - The Machine Instruction Language Compiler by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border="0"></a> 1.5.9  </small></address>
</body>
</html>
