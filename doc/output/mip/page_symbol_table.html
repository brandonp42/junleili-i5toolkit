<HTML>
  <HEAD>
    <meta http-equiv="Content-Type" content="text/html;charset=UTF-8">
    <TITLE>i5/OS Programmer's Toolkit - MI/EMI Programmer's Guide</TITLE>
    <link href="tabs.css" rel="stylesheet" type="text/css">
    <link href="doxygen.css" rel="stylesheet" type="text/css">
    <link href="docs.css" rel="stylesheet" type="text/css">

    <table width="100%" border="0" cellspacing="0" cellpadding="0">
      <tr>
        <td align="left">
          <a href="http://sourceforge.net/donate/index.php?group_id=254578"><img src="http://images.sourceforge.net/images/project-support.jpg" width="88" height="32" border="0" alt="Support This Project" /> </a>
        </td>
        <td align="right">
          <a href="http://sourceforge.net/projects/i5toolkit"><img src="http://sflogo.sourceforge.net/sflogo.php?group_id=254578&amp;type=13" width="120" height="30" alt="Get i5/OS Programmer's Toolkit at SourceForge.net. Fast, secure and Free Open Source software downloads" /></a>
        </td>

      </tr>
    </table>

  </HEAD>
  <body>
<!-- Generated by Doxygen 1.5.9 -->
<div class="navigation" id="top">
  <div class="tabs">
    <ul>
      <li><a href="index.html"><span>Main&nbsp;Page</span></a></li>
      <li class="current"><a href="pages.html"><span>Related&nbsp;Pages</span></a></li>
    </ul>
  </div>
</div>
<div class="contents">
<h1><a class="anchor" name="page_symbol_table">Analyzing the Symbol Table Component </a></h1>According to IBM's documentation, the symbol table component of an OPM MI program template is composed with the following two parts:<ul>
<li>Hashing table structure</li><li>Symbol table base segment</li></ul>
<p>
They are defined as SPC objects <em>symtbl-hash-t</em>, and <em>symtbl-base-t</em> in mip-h.emi like the following: <dl class="todo" compact><dt><b><a class="el" href="todo.html#_todo000006">Todo:</a></b></dt><dd>link to mip-h.emi </dd></dl>
<div class="fragment"><pre class="fragment"><span class="comment">/*</span>
<span class="comment"> hashing table of a symbol table component</span>
<span class="comment"> */</span>
dcl spc symtbl-hash-t bas(*)    ;
        <span class="comment">/* Number of hash buckets */</span>
        dcl dd symtbl-hash?num-buckets bin(4) dir ;
        <span class="comment">/*</span>
<span class="comment"> Each hash bucket contains an offset to the first symbol</span>
<span class="comment"> table base segment entry of the chain. This offset is from</span>
<span class="comment"> the beginning of the symbol table. The end of the chain has</span>
<span class="comment"> a -1 value.</span>
<span class="comment">         */</span>
        dcl dd symtbl-hash?buckets(1000) bin(4) dir ;

<span class="comment">/*</span>
<span class="comment"> symbol table base segment</span>
<span class="comment"> */</span>
dcl spc symtbl-base-t bas(*)    ;
        <span class="comment">/* Offset to next entry from beginning of the table. The end of the chain has a -1 value. */</span>
        dcl dd symtbl-base?next-entry-offset bin(4) unsgnd dir ;
        <span class="comment">/* ODT or MI number */</span>
        dcl dd symtbl-base?num bin(2) dir ;
        <span class="comment">/*</span>
<span class="comment"> bit 0. Instruction or ODT number</span>
<span class="comment">  0 = MI instruction number. This also means the symbol is the name of a LABEL in the program template.</span>
<span class="comment">  1 = ODT number. The symbol is the name of an ODT object.</span>
<span class="comment"> bit 1. Symbol origin</span>
<span class="comment">  0 = Compiler generated</span>
<span class="comment">  1 = Source program</span>
<span class="comment">         */</span> 
        dcl dd symtbl-base?flag <span class="keywordtype">char</span>(1) dir ;
        dcl dd symtbl-base?len  <span class="keywordtype">char</span>(1) dir ;
        dcl dd symtbl-base?name <span class="keywordtype">char</span>(15) dir ;
</pre></div><p>
Here is an sample MI program, tmip02.emi, that parses the symbol table component of OPM RPG program t143rpg.rpg. For the lastest source of tmip02, please refer to the svn repository of the project, <a href="https://....">https://....</a><p>
<dl class="remark" compact><dt><b>Remarks:</b></dt><dd>Yet, there is also an ILE RPG sample program (t146.rpgle) that implement the same job as tmip02.emi does.</dd></dl>
<dl class="todo" compact><dt><b><a class="el" href="todo.html#_todo000006">Todo:</a></b></dt><dd>link to tmip02.emi, t146.rpgle, and t143rpg.rpg </dd></dl>
<div class="fragment"><pre class="fragment"><span class="comment">/*</span>
<span class="comment"> @file tmip02.emi</span>
<span class="comment"></span>
<span class="comment"> Test of SPC objects: symtbl-hash-t, and symtbl-base-t.</span>
<span class="comment"> */</span>

entry *(pl-main) ext            ;

dcl spcptr .pgm-name parm          ;
dcl spcptr .pgm-type parm          ;
dcl ol pl-main(
        .pgm-name,
        .pgm-type
) parm ext ;

dcl dd pgm-name <span class="keywordtype">char</span>(10) bas(.pgm-name) ;
dcl dd pgm-type <span class="keywordtype">char</span>(2) bas(.pgm-type)  ;

dcl dd rt <span class="keywordtype">char</span>(34) auto         ;
dcl sysptr pgm auto             ;
        cpybrep rt, x'00'       ;
        cpybla  rt(1:2), pgm-type ;
        cpyblap rt(3:30),
          pgm-name, ' ' ;
        rslvsp  pgm, rt, *, *   ;
brk '1'                         ;

dcl spcptr p auto               ;
dcl dd len bin(4) auto          ;
        modasa p, 8             ;
        cpynv p-&gt;matpg?bytes-in, 8 ;
        matpg p, pgm               ;

        cpynv len, p-&gt;matpg?bytes-out ;
        modasa p, -8                  ;
        modasa p, len                 ;
        cpynv p-&gt;matpg?bytes-in, len  ;
        matpg  p, pgm                 ;
brk '2'                               ;

  calli dsp-header, *, dsp-header-ptr ;

dcl dd inx bin(2) auto          ;
dcl spcptr symtbl-start auto    ;
dcl spcptr hash auto            ;
dcl spcptr sym auto             ;

        addspp symtbl-start, p, p-&gt;matpg?symtbl-off ;
        addspp hash, p, p-&gt;matpg?symtbl-off         ;
        cpynv inx, 1            ;
loop-sym:
        cmpnv(b) inx, hash-&gt;symtbl-hash?num-buckets / hi(end-loop-sym);

        <span class="comment">/* skip invalid BUCKET */</span>
        cmpnv(b) hash-&gt;symtbl-hash?buckets(inx), -1 / eq(next-bucket) ;

        addspp sym, symtbl-start, hash-&gt;symtbl-hash?buckets(inx) ;
        calli dsp-symbol, *, dsp-symbol-ptr ;

        <span class="comment">/* has next entry? */</span>
        cmpnv(b) sym-&gt;symtbl-base?next-entry-offset, -1 / eq(next-bucket) ;
        addspp sym, symtbl-start, sym-&gt;symtbl-base?next-entry-offset ;
        calli dsp-symbol, *, dsp-symbol-ptr ;
next-bucket:       

brk "WHERE"                     ;
        addn(s) inx, 1          ;
        b loop-sym              ;
end-loop-sym:   

brk 'END'                       ;
        neg(s) len              ;
        modasa p, len           ;
        rtx *                   ;

<span class="comment">/*</span>
<span class="comment"> display a symbol table entry</span>
<span class="comment"></span>
<span class="comment"> @pre SPPPTR sym</span>
<span class="comment"> */</span>
dcl insptr dsp-symbol-ptr auto  ;
entry dsp-symbol <span class="keywordtype">int</span>            ;

dcl dd msg <span class="keywordtype">char</span>(64) auto        ;
        dcl dd fld-odt znd(8,0) def(msg) pos(1) ;
        dcl dd fld-inst znd(8,0) def(msg) pos(11) ;
        dcl dd fld-sym-name <span class="keywordtype">char</span>(16) def(msg) pos(21) ;
        dcl dd fld-sym-org <span class="keywordtype">char</span>(20) def(msg) pos(37)  ;
dcl spcptr fld-sym-name-ptr auto  ;
dcl spcptr symbol-name-ptr auto   ;
dcl dd symbol-len bin(2) auto     ;
        dcl dd symbol-len-lo <span class="keywordtype">char</span>(1) def(symbol-len) pos(2) ;

        cpybrep msg, ' '        ;
        <span class="comment">/* symbol name */</span>
        cpybrep fld-sym-name, ' ' ;
        setspp fld-sym-name-ptr, fld-sym-name      ;
        setspp symbol-name-ptr, sym-&gt;symtbl-base?name ;
        cpybla symbol-len-lo, sym-&gt;symtbl-base?len    ;
        %memcpy(fld-sym-name-ptr,
                symbol-name-ptr,
                symbol-len) ;
        <span class="comment">/* ODT number or MI instruction number */</span>
        tstbts(b) sym-&gt;symtbl-base?flag, 0 / zer(=+3) ;
        cpynv fld-odt, sym-&gt;symtbl-base?num           ; <span class="comment">/* flag bit 0 = 1, ODT number */</span>
        b =+2                                         ;
:
        cpynv fld-inst, sym-&gt;symtbl-base?num ;          <span class="comment">/* flag bit 0 = 0, MI instruction */</span>
:
        <span class="comment">/* Symbol origin */</span>
        tstbts(b) sym-&gt;symtbl-base?flag, 1 / zer(=+3) ;
        cpybla fld-sym-org, "Source program"          ; <span class="comment">/* flag bit 1 = 1. source program */</span>
        b =+2                                         ;
:
        cpybla fld-sym-org, "Compiler generated" ; <span class="comment">/* flag bit 1 = 0. compiler generated */</span>
:       
        %sendmsg(msg , 64)      ;

        b dsp-symbol-ptr        ;

dcl insptr dsp-header-ptr auto  ;
entry dsp-header <span class="keywordtype">int</span>            ;

        cpyblap msg, "HLL Symbol Table", " " ;
        %sendmsg(msg , 64)      ;
        cpyblap msg, pgm-name, " " ;
        cvthc   msg(11:4), pgm-type ;
        %sendmsg(msg , 64)      ;
        cpyblap msg, "ODT Ref   MI Inst   Symbol Name     Symbol Org",
          " "                   ;
        %sendmsg(msg , 64)      ;

        b dsp-header-ptr        ;

/include mip-h.emi              ;
pend                            ;
</pre></div><p>
Call TMIP02 like the following: <div class="fragment"><pre class="fragment">CALL TMIP02 (<span class="stringliteral">'T143RPG'</span> X<span class="stringliteral">'0201)</span>
</pre></div><p>
The output is the following: <pre>
HLL Symbol Table                                  
T143RPG   0201                                    
ODT Ref   MI Inst   Symbol Name     Symbol Org    
00000240            ZIGNDECD        Source program
          00000022  *GETIN          Source program
00000023            ARR             Source program
00000076            *MONTH          Source program
00000024            WHR             Source program
00000072            *DATE           Source program
00000017            *INXX           Source program
00000020            *IN             Source program
          00000089  S.ARR           Source program
          00000138  *CANCL          Source program
00000087            M.*YEAR         Source program
00000085            M.*DAY          Source program
          00000084  *DETL           Source program
          00000037  *TOTC           Source program
00000086            M.*MONTH        Source program
00000078            *DAY            Source program
00000013            *ON             Source program
00000083            M.UYEAR         Source program
00000080            M.UDATE         Source program
          00000038  *TOTL           Source program
00000118            ZPGMSTUS        Source program
00000079            UDAY            Source program
00000077            UMONTH          Source program
00000262            C.PGMJTM        Source program
00000082            M.UMONTH        Source program
00000073            UDATE           Source program
00000022            *IN91           Source program
00000019            *INLR           Source program
00000030            WORK.           Source program
00000016            *INIT           Source program
00000263            C*DATE          Source program
00000014            *OFF            Source program
          00000039  *OFL            Source program
00000075            UYEAR           Source program
          00000041  *DETC           Source program
00000074            *YEAR           Source program
00000081            M.UDAY          Source program
          00000146  *TERM           Source program
00000084            M.*DATE         Source program
</pre> </div>
<hr size="1">

<a href="http://sourceforge.net/donate/index.php?group_id=254578"><img src="http://images.sourceforge.net/images/project-support.jpg" width="88" height="32" border="0" alt="Support This Project" /> </a>

<address style="text-align: right;"><small>Generated on Tue May 10 19:55:10 2011 for i5/OS Programmer's Toolkit: OPM MI Disassembler by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border="0"></a> 1.5.9  </small></address>
</body>
</html>
