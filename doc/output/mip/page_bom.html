<HTML>
  <HEAD>
    <meta http-equiv="Content-Type" content="text/html;charset=UTF-8">
    <TITLE>i5/OS Programmer's Toolkit - MI/EMI Programmer's Guide</TITLE>
    <link href="tabs.css" rel="stylesheet" type="text/css">
    <link href="doxygen.css" rel="stylesheet" type="text/css">
    <link href="docs.css" rel="stylesheet" type="text/css">

    <table width="100%" border="0" cellspacing="0" cellpadding="0">
      <tr>
        <td align="left">
          <a href="http://sourceforge.net/donate/index.php?group_id=254578"><img src="http://images.sourceforge.net/images/project-support.jpg" width="88" height="32" border="0" alt="Support This Project" /> </a>
        </td>
        <td align="right">
          <a href="http://sourceforge.net/projects/i5toolkit"><img src="http://sflogo.sourceforge.net/sflogo.php?group_id=254578&amp;type=13" width="120" height="30" alt="Get i5/OS Programmer's Toolkit at SourceForge.net. Fast, secure and Free Open Source software downloads" /></a>
        </td>

      </tr>
    </table>

  </HEAD>
  <body>
<!-- Generated by Doxygen 1.5.9 -->
<div class="navigation" id="top">
  <div class="tabs">
    <ul>
      <li><a href="index.html"><span>Main&nbsp;Page</span></a></li>
      <li class="current"><a href="pages.html"><span>Related&nbsp;Pages</span></a></li>
    </ul>
  </div>
</div>
<div class="contents">
<h1><a class="anchor" name="page_bom">Analyzing the BOM Table Component </a></h1>The breakpoint offset mapping (BOM) table component of an OPM MI component stores the mappings from breakpoints of an OPM MI program to corresponding MI instruction numbers. A breakpoint in an MI program is produced by a break directive statement (BRK) in the MI source of the program. The BRK directive statement allows symbolic breakpoints to be defined. The following diagram and table show the break directive statement: <div class="fragment"><pre class="fragment">BRK string1;
</pre></div> <dl class="remark" compact><dt><b>Remarks:</b></dt><dd><em>string1</em> is the name of the breakpoint.</dd></dl>
The BOM table component can be used by compilers to relate high-level language statement numbers to instruction numbers. For example, the OPM RPG compiler and the OPM CL compiler stores the sequence number of source records as HLL statement numbers (breakpoint names in the MI source). While the OPM COBOL compiler generates HLL statement numbers according to a collection of validated source statements; for example, empty lines are omitted.<p>
The BOM table has the 2 formats depending on the BOM table flags (<em>matpg?bom-flag</em>). If the flag indicates to use new BOM table format, then the first bit of the MI instruction number is not a flag, so numbers up to 64k-1 can be used. The 2 BOM formats are defined as <em>bom-entry0-t</em>, and <em>bom-entry1-t</em> in mip-h.emi like the following: <dl class="todo" compact><dt><b><a class="el" href="todo.html#_todo000003">Todo:</a></b></dt><dd>link </dd></dl>
<div class="fragment"><pre class="fragment">
dcl spc bom-entry0-t bas(*)     ;
        <span class="comment">/*</span>
<span class="comment"> bit 0. Format flag.</span>
<span class="comment">  0 = HLL statement number is in character format</span>
<span class="comment">  1 = HLL statement number is in numeric format</span>
<span class="comment">         */</span>
        dcl dd bome0?mi-inst bin(2) unsgnd dir ;
        dcl dd bome0?hll-stmt-str <span class="keywordtype">char</span>(10) dir ;
        dcl dd bome0?hll-stmt-num bin(2) def(bome0?hll-stmt-str) ;

dcl spc bom-entry1-t bas(*)     ;
        dcl dd bome1?mi-inst bin(2) unsgnd dir ;
        <span class="comment">/*</span>
<span class="comment"> bit 0. Format flag.</span>
<span class="comment">  0 = HLL statement number is in character format</span>
<span class="comment">  1 = HLL statement number is in numeric format</span>
<span class="comment">         */</span>
        dcl dd bome1?fmt <span class="keywordtype">char</span>(1) dir      ;
        dcl dd bome1?hll-stmt-str <span class="keywordtype">char</span>(10) dir ;
        dcl dd bome1?hll-stmt-num bin(2) def(bome1?hll-stmt-str) ;
</pre></div><p>
The following is an example MI program (tmip03.emi) that parses the BOM table component of OPM RPG program t143rpg.rpg. <div class="fragment"><pre class="fragment"><span class="comment">/*</span>
<span class="comment"> @file tmip03.emi</span>
<span class="comment"></span>
<span class="comment"> Parse the BOM of an OPM MI program template.</span>
<span class="comment"> */</span>

entry *(pl-main) ext            ;

dcl spcptr .pgm-name parm       ;
dcl spcptr .pgm-type parm       ;
dcl ol pl-main(
        .pgm-name,
        .pgm-type
) parm ext ;

dcl dd pgm-name <span class="keywordtype">char</span>(10) bas(.pgm-name) ;
dcl dd pgm-type <span class="keywordtype">char</span>(2) bas(.pgm-type)  ;

dcl dd rt <span class="keywordtype">char</span>(34) auto         ;
dcl sysptr pgm auto             ;
        cpybrep rt, x'00'       ;
        cpybla  rt(1:2), pgm-type ;
        cpyblap rt(3:30),
          pgm-name, ' ' ;
        rslvsp  pgm, rt, *, *   ;
brk '1'                         ;

dcl spcptr p auto               ;
dcl dd len bin(4) auto          ;
        modasa p, 8             ;
        cpynv p-&gt;matpg?bytes-in, 8 ;
        matpg p, pgm               ;

        cpynv len, p-&gt;matpg?bytes-out ;
        modasa p, -8                  ;
        modasa p, len                 ;
        cpynv p-&gt;matpg?bytes-in, len  ;
        matpg  p, pgm                 ;
brk '2'                               ;

        <span class="comment">/* does tmpl-extension exists? */</span>
        tstbts(b) p-&gt;matpg?pgm-attr, 10 / zer(see-you) ;

        <span class="comment">/* determine BOM format */</span>
dcl dd new-bom-fmt <span class="keywordtype">char</span>(1) auto ;
        tstbts(i) p-&gt;matpg?bom-flag, 0
          / nzer(new-bom-fmt) ;

        <span class="comment">/* determin length of a BOM entry */</span>
dcl dd bome-len bin(2) auto     ;
        cmpbla(b) new-bom-fmt, '1'
          / eq(=+3) ;
        addn(s) bome-len, 2     ;
        b =+2                   ;
:
        addn(s) bome-len, 3     ;
:
        addn(s) bome-len, p-&gt;matpg?bome-len ;

        <span class="comment">/* locate the BOM component */</span>
dcl spcptr pos auto             ;
        addspp pos, p,
          p-&gt;matpg?bom-off      ;
dcl dd n bin(4) auto            ;
        cpynv n, 0              ;
bom-loop:
        <span class="comment">/* determine breakpoint format */</span>
dcl dd <span class="keywordtype">char</span>-fmt <span class="keywordtype">char</span>(1) auto    ;
        cmpbla(b) new-bom-fmt, '1'
          / eq(=+3)             ;
        tstbts(i) pos-&gt;bome0?mi-inst, 0
          / eq(<span class="keywordtype">char</span>-fmt)      ; <span class="comment">/* old BOM format */</span>
        b =+2                   ;
:
        tstbts(i) pos-&gt;bome1?fmt, 0
          / eq(<span class="keywordtype">char</span>-fmt)        ;
:
        <span class="comment">/* print a BOM entry */</span>
        calli print-bom-entry, *, print-bom-entry-ptr ;

        addn(s) n, bome-len     ;
        cmpnv(b) n, p-&gt;matpg?bom-len
          / nlo(end-bom-loop)   ;
        addspp pos, pos, bome-len ;
        b bom-loop              ;
end-bom-loop:       

see-you:        
        neg(s) len              ;
        modasa p, len           ;
        rtx *                   ;

dcl dd msg <span class="keywordtype">char</span>(64) auto        ;
        dcl dd msg-inst znd(6) def(msg) pos(1)    ;
        dcl dd msg-bkp  <span class="keywordtype">char</span>(10) def(msg) pos(26) ;

<span class="comment">/*</span>
<span class="comment"> print-bom-entry</span>
<span class="comment"></span>
<span class="comment"> @pre char-fmt, pos, p-&gt;matpg?bome-len</span>
<span class="comment"> */</span>
dcl insptr print-bom-entry-ptr auto ;
entry print-bom-entry <span class="keywordtype">int</span>           ;

dcl spcptr hll-stmt-ptr auto    ;
dcl dd hll-stmt-num <span class="keywordtype">char</span>(2) bas(hll-stmt-ptr) ;
dcl spcptr msg-bkp-ptr auto                  ;

        cpybrep msg, " "        ;

        cmpbla(b) new-bom-fmt, '1'
          / eq(=+5)             ;
        setspp hll-stmt-ptr, pos-&gt;bome0?hll-stmt-str ;
        clrbts pos-&gt;bome0?mi-inst, 0                 ;
        cpynv msg-inst, pos-&gt;bome0?mi-inst           ;
        b =+3                   ;
:
        setspp hll-stmt-ptr, pos-&gt;bome1?hll-stmt-str ;
        cpynv msg-inst, pos-&gt;bome1?mi-inst           ;
:
        <span class="comment">/* breakpoint name or number */</span>
        cmpbla(b) <span class="keywordtype">char</span>-fmt, '1'
          / neq(numeric-bkp) ;
        setspp msg-bkp-ptr, msg-bkp ;
        %memcpy(msg-bkp-ptr,
                hll-stmt-ptr,
                p-&gt;matpg?bome-len) ;
        b end-bkp         ;
numeric-bkp:
        cvthc msg-bkp, hll-stmt-num ;
end-bkp:

        %sendmsg(msg, 64)       ;

        b print-bom-entry-ptr   ;

/include mip-h.emi              ;

pend                            ;
</pre></div><p>
Call TMIP03 like the following: <div class="fragment"><pre class="fragment">CALL TMIP03 (<span class="stringliteral">'T143RPG'</span> X<span class="stringliteral">'0201'</span>)
</pre></div><p>
The output of TMIP03 is the following: <pre>
000001                   .ENTRY 
000003                   .STOP  
000005                   PROG DS
000005                   .DUMP  
000022                   *GETIN 
000030                   .ERX   
000037                   *TOTC  
000038                   *TOTL  
000039                   *OFL 
000041                   *DETC
000042                   200  
000043                   300  
000044                   400  
000045                   500  
000046                   600  
000047                   700  
000056                   800  
000069                   900  
000082                   1000 
000084                   *DETL
000089                   .SORT   
000089                   S.ARR   
000103                   *INIT   
000134                   .SENDMSG
000138                   *CANCL  
000146                   *TERM   
000150                   .FILERR 
000151                   .ERR    
000178                   .END0002
000182                   .END0001
000185                   .DEACTPG
000192                   .EXCPTON
</pre> </div>
<hr size="1">

<a href="http://sourceforge.net/donate/index.php?group_id=254578"><img src="http://images.sourceforge.net/images/project-support.jpg" width="88" height="32" border="0" alt="Support This Project" /> </a>

<address style="text-align: right;"><small>Generated on Tue May 10 19:55:10 2011 for i5/OS Programmer's Toolkit: OPM MI Disassembler by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border="0"></a> 1.5.9  </small></address>
</body>
</html>
